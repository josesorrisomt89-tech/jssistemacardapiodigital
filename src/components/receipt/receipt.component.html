<style>
  @media print {
    body * {
      visibility: hidden;
    }
    .receipt-container, .receipt-container * {
      visibility: visible;
    }
    .receipt-container {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      border: none;
    }
    .no-print {
      display: none !important;
    }
    @page {
      size: 80mm auto;
      margin: 2mm;
    }
  }
</style>

<div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
  <div class="bg-gray-800 rounded-lg w-full max-w-sm flex flex-col max-h-[90vh]">
    <!-- Header -->
    <div class="p-4 border-b border-gray-700 flex justify-between items-center no-print">
      <h3 class="text-xl font-bold">Cupom Fiscal</h3>
      <button (click)="close.emit()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
    </div>

    <!-- Receipt Content -->
    <div class="receipt-container p-4 overflow-y-auto">
      <div id="printable-receipt" class="bg-white text-black font-mono text-xs w-full max-w-md mx-auto p-4">
        <div class="text-center">
          <h2 class="text-lg font-bold">{{ settings().name }}</h2>
          <p>{{ settings().address }}</p>
          <p>WhatsApp: {{ settings().whatsapp }}</p>
        </div>
        <div class="border-t border-b border-dashed border-black my-2 py-1">
          <p class="flex justify-between"><span>Pedido:</span> <span>#{{ order().id.slice(-6).toUpperCase() }}</span></p>
          <p class="flex justify-between"><span>Data:</span> <span>{{ order().date | date:'dd/MM/yy HH:mm' }}</span></p>
          <p class="font-bold mt-1">DADOS DO CLIENTE:</p>
          <p>Nome: {{ order().customer_name }}</p>
          @if (order().delivery_option === 'delivery') {
            <p>Endereço: {{ order().delivery_address }}, {{ order().neighborhood }}</p>
          } @else {
            <p>Opção: Retirada na Loja</p>
          }
        </div>
        <div>
          <h3 class="text-center font-bold mb-1">ITENS</h3>
          @for(item of order().items; track $index) {
            <div class="mb-1 border-b border-dotted border-black pb-1">
              <div class="flex justify-between">
                <span class="font-bold">{{ item.quantity }}x {{ item.product_name }} @if(item.size.name !== 'Único') { ({{ item.size.name }}) }</span>
                <span>{{ item.size.price | currency:'BRL' }}</span>
              </div>
              @if(item.addons.length > 0) {
                <div class="pl-2 text-[10px]">
                    @for (group of getGroupedAddons(item); track group.categoryName) {
                        <div class="mt-1">
                            <p class="font-semibold italic">{{ group.categoryName }}:</p>
                            @for (addon of group.addons; track addon.id) {
                                <p class="pl-2 flex justify-between">
                                    <span>- {{ addon.name }}</span>
                                    <span>{{ addon.price > 0 ? (addon.price | currency:'BRL') : 'Grátis' }}</span>
                                </p>
                            }
                        </div>
                    }
                </div>
              }
            </div>
          }
        </div>
        <div class="border-t border-dashed border-black mt-2 pt-1">
          <p class="flex justify-between"><span>Subtotal:</span> <span>{{ order().subtotal | currency:'BRL' }}</span></p>
          <p class="flex justify-between"><span>Taxa de Entrega:</span> <span>{{ order().delivery_fee | currency:'BRL' }}</span></p>
          @if(order().discount_amount && order().discount_amount > 0) {
            <p class="flex justify-between"><span>Desconto ({{order().coupon_code}}):</span> <span>-{{ order().discount_amount | currency:'BRL' }}</span></p>
          }
          @if(order().shipping_discount_amount && order().shipping_discount_amount > 0) {
            <p class="flex justify-between"><span>Desc. Frete ({{order().coupon_code}}):</span> <span>-{{ order().shipping_discount_amount | currency:'BRL' }}</span></p>
          }
          @if(order().loyalty_discount_amount && order().loyalty_discount_amount > 0) {
             <p class="flex justify-between"><span>Desc. Fidelidade:</span> <span>-{{ order().loyalty_discount_amount | currency:'BRL' }}</span></p>
          }
           @if(order().loyalty_shipping_discount_amount && order().loyalty_shipping_discount_amount > 0) {
             <p class="flex justify-between"><span>Frete Grátis (Fidelidade):</span> <span>-{{ order().loyalty_shipping_discount_amount | currency:'BRL' }}</span></p>
          }
          <p class="flex justify-between font-bold text-sm"><span>TOTAL:</span> <span>{{ order().total | currency:'BRL' }}</span></p>
        </div>
        <div class="text-center mt-4">
          <p>Pagamento: {{ order().payment_method }}
            @if(order().payment_method === 'cash' && order().change_for) {
              <span>(Troco para {{order().change_for | currency:'BRL'}})</span>
            }
          </p>
          <p class="font-bold mt-2">Obrigado pela preferência!</p>
        </div>
      </div>
    </div>

    <!-- Footer with action buttons -->
    <div class="p-4 border-t border-gray-700 flex justify-end items-center space-x-2 no-print">
      @switch (mode()) {
        @case ('print') {
          <button (click)="printReceipt()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
            Imprimir
          </button>
        }
        @case ('delivery') {
          <button (click)="close.emit()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">
            Cancelar
          </button>
          <button (click)="confirmAction()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
            Confirmar e Enviar
          </button>
        }
        @case ('pdv') {
          <button (click)="close.emit()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-sm">Fechar</button>
          <button (click)="sendWhatsApp.emit()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Enviar WhatsApp</button>
          <button (click)="printReceipt()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Imprimir</button>
        }
      }
    </div>
  </div>
</div>