<div class="min-h-screen bg-gray-800 text-white p-4 sm:p-6 lg:p-8">
  <audio #newOrderSound src="https://cdn.jsdelivr.net/gh/scottschiller/SoundManager2@master/demo/audio/bell.mp3" loop></audio>
  
  @if (isNewOrderNotificationActive()) {
    <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-green-500 text-white text-center font-bold p-3 rounded-lg shadow-lg animate-pulse">
      <p>游댒 NOVO PEDIDO RECEBIDO! 游댒</p>
      <p class="text-xs font-normal">Altere o status do pedido para silenciar o alarme.</p>
    </div>
  }

  @if (!isLoggedIn()) {
    <div class="max-w-md mx-auto bg-gray-900 p-8 rounded-lg shadow-lg mt-20">
      <h1 class="text-2xl font-bold text-center mb-6 text-purple-400">Acesso Restrito</h1>
      <form [formGroup]="loginForm" (ngSubmit)="handleLogin()" class="space-y-4">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Usu치rio</label>
          <input type="text" id="username" formControlName="username" class="w-full bg-gray-700 border-gray-600 rounded-md p-2 focus:ring-purple-500 focus:border-purple-500">
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
          <input type="password" id="password" formControlName="password" class="w-full bg-gray-700 border-gray-600 rounded-md p-2 focus:ring-purple-500 focus:border-purple-500">
        </div>
        @if (loginError()) {
          <p class="text-red-500 text-sm text-center">{{ loginError() }}</p>
        }
        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg">Entrar</button>
      </form>
    </div>
  } @else {
    <div class="max-w-7xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-purple-400">Painel Administrativo</h1>
        <button (click)="logout()" class="text-sm text-gray-400 hover:text-white">Sair</button>
      </div>

      <!-- Tabs -->
      <div class="border-b border-gray-700 mb-6 overflow-x-auto scrollbar-hide">
        <nav class="-mb-px flex space-x-6" aria-label="Tabs">
          <button (click)="activeTab.set('orders')" class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap relative" [class.border-purple-500]="activeTab() === 'orders'" [class.text-purple-400]="activeTab() === 'orders'" [class.border-transparent]="activeTab() !== 'orders'" [class.text-gray-400]="activeTab() !== 'orders'">
            Pedidos Ativos
             @if (isNewOrderNotificationActive()) {
              <span class="absolute top-2 -right-3 flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
              </span>
            }
          </button>
          <button (click)="activeTab.set('pdv')" class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap" [class.border-purple-500]="activeTab() === 'pdv'" [class.text-purple-400]="activeTab() === 'pdv'" [class.border-transparent]="activeTab() !== 'pdv'" [class.text-gray-400]="activeTab() !== 'pdv'">PDV</button>
          <button (click)="activeTab.set('sales')" class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap" [class.border-purple-500]="activeTab() === 'sales'" [class.text-purple-400]="activeTab() === 'sales'" [class.border-transparent]="activeTab() !== 'sales'" [class.text-gray-400]="activeTab() !== 'sales'">Vendas</button>
          <button (click)="activeTab.set('accounts')" class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap" [class.border-purple-500]="activeTab() === 'accounts'" [class.text-purple-400]="activeTab() === 'accounts'" [class.border-transparent]="activeTab() !== 'accounts'" [class.text-gray-400]="activeTab() !== 'accounts'">Contas</button>
          <button (click)="activeTab.set('products')" class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap" [class.border-purple-500]="activeTab() === 'products'" [class.text-purple-400]="activeTab() === 'products'" [class.border-transparent]="activeTab() !== 'products'" [class.text-gray-400]="activeTab() !== 'products'">Produtos</button>
          <button (click)="activeTab.set('drivers')" class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap" [class.border-purple-500]="activeTab() === 'drivers'" [class.text-purple-400]="activeTab() === 'drivers'" [class.border-transparent]="activeTab() !== 'drivers'" [class.text-gray-400]="activeTab() !== 'drivers'">Entregadores</button>
          <button (click)="activeTab.set('loyalty')" class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap" [class.border-purple-500]="activeTab() === 'loyalty'" [class.text-purple-400]="activeTab() === 'loyalty'" [class.border-transparent]="activeTab() !== 'loyalty'" [class.text-gray-400]="activeTab() !== 'loyalty'">Fidelidade</button>
          <button (click)="activeTab.set('coupons')" class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap" [class.border-purple-500]="activeTab() === 'coupons'" [class.text-purple-400]="activeTab() === 'coupons'" [class.border-transparent]="activeTab() !== 'coupons'" [class.text-gray-400]="activeTab() !== 'coupons'">Cupons</button>
          <button (click)="activeTab.set('settings')" class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap" [class.border-purple-500]="activeTab() === 'settings'" [class.text-purple-400]="activeTab() === 'settings'" [class.border-transparent]="activeTab() !== 'settings'" [class.text-gray-400]="activeTab() !== 'settings'">Configura칞칫es</button>
          <button (click)="activeTab.set('layout')" class="py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap" [class.border-purple-500]="activeTab() === 'layout'" [class.text-purple-400]="activeTab() === 'layout'" [class.border-transparent]="activeTab() !== 'layout'" [class.text-gray-400]="activeTab() !== 'layout'">Layout</button>
        </nav>
      </div>

      <!-- Content -->
      <div>
        @switch (activeTab()) {
          @case ('orders') {
            <div class="bg-gray-900 p-6 rounded-lg h-[85vh] flex flex-col">
              <h2 class="text-2xl font-semibold mb-4 flex-shrink-0">Pedidos Ativos</h2>
          
              <!-- Scheduled Orders Section -->
              <div class="mb-6 flex-shrink-0">
                <h3 class="text-xl font-semibold text-yellow-400 mb-2">Agendados ({{ scheduledOrders().length }})</h3>
                @if (scheduledOrders().length > 0) {
                  <div class="flex space-x-4 overflow-x-auto pb-4 scrollbar-hide">
                    @for (order of scheduledOrders(); track order.id) {
                      <div class="w-72 flex-shrink-0 bg-gray-800 rounded-lg p-3">
                        <p class="font-bold">{{order.customer_name}} - <span class="text-purple-400">{{order.total | currency:'BRL'}}</span></p>
                        <p class="text-sm font-semibold text-yellow-400">PARA: {{ order.scheduled_time }}</p>
                        <p class="text-xs text-gray-400 mt-1">{{ order.delivery_option === 'pickup' ? 'Retirada na Loja' : order.delivery_address + ', ' + order.neighborhood }}</p>
                        <select [value]="order.status" (change)="updateOrderStatus(order.id, $event)" class="w-full bg-gray-700 p-2 rounded text-sm mt-2">
                          @for(status of orderStatuses; track status) { <option [value]="status">{{status}}</option> }
                        </select>
                      </div>
                    }
                  </div>
                } @else {
                  <p class="text-gray-500 text-sm">Nenhum pedido agendado.</p>
                }
              </div>
          
              <!-- Kanban Board -->
              <div class="flex-grow flex space-x-4 overflow-x-auto pb-2">
                @for (column of kanbanColumns; track column.title) {
                  <div class="w-80 flex-shrink-0 bg-gray-800 rounded-lg flex flex-col">
                    <!-- Column Header -->
                    <h3 class="text-lg font-semibold p-3 border-b border-gray-700 flex-shrink-0">{{ column.title }} ({{ column.orders().length }})</h3>
                    <!-- Column Cards -->
                    <div class="p-2 space-y-3 overflow-y-auto flex-grow">
                      @for (order of column.orders(); track order.id) {
                        <div class="bg-gray-900 rounded-lg p-3 space-y-2">
                          <p class="font-bold">{{order.customer_name}} - <span class="text-purple-400">{{order.total | currency:'BRL'}}</span></p>
                          <p class="text-sm text-gray-400">{{ order.delivery_option === 'pickup' ? 'Retirada na Loja' : order.delivery_address + ', ' + order.neighborhood }}</p>
                          <p class="text-xs text-gray-500">{{order.date | date:'dd/MM/yyyy HH:mm'}}</p>
                          
                           @if(order.delivery_option === 'delivery') {
                            @if(order.assigned_driver_name) {
                              <div class="text-sm">
                                  @if(order.status === 'Saiu para Entrega') {
                                      <p class="font-semibold text-blue-400">A caminho com {{order.assigned_driver_name}}</p>
                                  } @else if(order.status === 'Em Preparo' || order.status === 'Aguardando Retirada') {
                                      <p class="font-semibold text-yellow-400">Aguardando sa칤da de {{order.assigned_driver_name}}</p>
                                  }
                              </div>
                            } @else if (order.is_delivery_broadcasted) {
                              <p class="text-sm font-semibold text-yellow-400">Aguardando aceite do entregador.</p>
                            } @else {
                              <p class="text-sm font-semibold text-gray-400">Aguardando chamar entregador.</p>
                            }
                          }

                          <div class="border-t border-gray-700 pt-2 text-sm">
                            @for (item of order.items; track $index) {
                                <div class="flex justify-between">
                                    <span>{{item.quantity}}x {{item.product_name}} @if(item.size.name !== '칔nico') { ({{item.size.name}}) }</span>
                                    <span>{{item.size.price | currency:'BRL'}}</span>
                                </div>
                                @if(item.addons.length > 0) {
                                    <div class="pl-2 text-xs text-gray-400">
                                        @for(addon of item.addons; track addon.id) {
                                            <div class="flex justify-between">
                                                <span class="truncate pr-2">- {{addon.name}}</span>
                                                <span>{{ addon.price > 0 ? '+' + (addon.price | currency:'BRL') : '' }}</span>
                                            </div>
                                        }
                                    </div>
                                }
                            }
                          </div>
                          
                          <select [value]="order.status" (change)="updateOrderStatus(order.id, $event)" class="w-full bg-gray-700 p-2 rounded text-sm">
                            @for(status of orderStatuses; track status) { <option [value]="status">{{status}}</option> }
                          </select>
                          
                          <div class="space-y-2">
                            @if(order.delivery_option === 'delivery' && (order.status === 'Em Preparo' || order.status === 'Aguardando Retirada' || order.status === 'Recebido')) {
                              <button (click)="openDriverAssignmentModal(order)" class="w-full text-sm bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg">
                                {{ order.is_delivery_broadcasted || order.assigned_driver_id ? 'Trocar Entregador' : 'Chamar Entregador' }}
                              </button>
                              @if(order.is_delivery_broadcasted || order.assigned_driver_id) {
                                <button (click)="cancelDelivery(order.id)" class="w-full text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg">
                                  Cancelar Entrega
                                </button>
                              }
                            }
                            @if(order.delivery_option === 'delivery') {
                               <button (click)="openReceiptModal(order, 'delivery')" class="w-full text-sm bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg">Enviar via WhatsApp</button>
                            }
                            <button (click)="openReceiptModal(order, 'print')" class="w-full text-sm bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg">
                              Imprimir Cupom
                            </button>
                          </div>
                        </div>
                      }
                      @if (column.orders().length === 0) {
                        <div class="flex items-center justify-center h-full">
                          <p class="text-gray-500 text-sm">Nenhum pedido aqui.</p>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }
          @case('pdv') {
            @if (pdvState() === 'selecting') {
              <div class="bg-gray-900 p-6 rounded-lg text-center h-[80vh] flex flex-col items-center justify-center">
                <h2 class="text-2xl font-semibold mb-8">Qual o tipo do pedido?</h2>
                <div class="flex flex-col sm:flex-row gap-6 w-full max-w-md">
                  <button (click)="startPdvOrder('delivery')" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-6 px-8 rounded-lg text-xl transition-transform transform hover:scale-105">
                    Delivery
                  </button>
                  <button (click)="startPdvOrder('balcao')" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-6 px-8 rounded-lg text-xl transition-transform transform hover:scale-105">
                    Balc칚o
                  </button>
                </div>
              </div>
            } @else {
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Product Selection -->
                <div class="lg:col-span-2 bg-gray-900 p-6 rounded-lg max-h-[80vh] overflow-y-auto relative">
                  @if(dataService.settings().pdv_background_image_url) {
                      <div class="absolute inset-0 bg-cover bg-center opacity-10 rounded-lg" [style.backgroundImage]="'url(' + dataService.settings().pdv_background_image_url + ')'"></div>
                  }
                  <div class="relative z-10">
                      <h2 class="text-2xl font-semibold mb-4">Ponto de Venda ({{ pdvState() === 'delivery' ? 'Delivery' : 'Balc칚o' }})</h2>
                      @for(category of sortedCategories(); track category.id) {
                          <div class="mb-6">
                              <h3 class="text-xl font-bold text-purple-400 mb-3">{{category.name}}</h3>
                              <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
                                  @for(product of sortedProducts(); track product.id) {
                                      @if(product.category_id === category.id) {
                                          <div (click)="openPdvProductModal(product)" 
                                            class="bg-gray-800 p-3 rounded-lg flex flex-col justify-between hover:ring-2 ring-purple-500 transition-all relative"
                                            [class.cursor-pointer]="product.is_available"
                                            [class.cursor-not-allowed]="!product.is_available"
                                            [class.opacity-50]="!product.is_available">
                                              @if (!product.is_available) {
                                                <div class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center z-10 rounded-lg">
                                                  <span class="text-white font-semibold bg-red-600 px-2 py-0.5 rounded-md text-xs">Indispon칤vel</span>
                                                </div>
                                              }
                                              <div class="flex items-start space-x-3">
                                                  <img [src]="product.image_url || 'https://via.placeholder.com/100'" alt="{{product.name}}" class="w-16 h-16 rounded-md object-cover">
                                                  <div>
                                                      <p class="font-semibold">{{product.name}}</p>
                                                      <p class="text-xs text-gray-400">
                                                        @if (product.price_type === 'fixed') {
                                                          {{ product.price | currency:'BRL' }}
                                                        } @else {
                                                          A partir de {{ product.sizes[0]?.price | currency:'BRL' }}
                                                        }
                                                      </p>
                                                  </div>
                                              </div>
                                          </div>
                                      }
                                  }
                              </div>
                          </div>
                      }
                  </div>
                </div>
                <!-- Cart & Checkout -->
                <div class="bg-gray-900 p-4 rounded-lg">
                  <h3 class="text-xl font-semibold mb-4">Pedido Atual</h3>
                  <div class="space-y-2 max-h-60 overflow-y-auto mb-4 pr-2">
                    @for(item of pdvCart(); track $index) {
                      <div class="bg-gray-800 p-2 rounded flex justify-between items-center">
                          <div>
                            <p class="text-sm font-medium">{{item.product_name}} @if(item.size.name !== '칔nico'){ ({{item.size.name}}) } </p>
                              @if(item.addons.length > 0) {
                                  <p class="text-xs text-gray-400">{{ getAddonNames(item.addons) }}</p>
                              }
                            <div class="flex items-center space-x-2 mt-1">
                              <button (click)="decrementPdvCartItem($index)" class="w-5 h-5 rounded bg-gray-700">-</button>
                              <span class="text-sm">{{item.quantity}}</span>
                              <button (click)="incrementPdvCartItem($index)" class="w-5 h-5 rounded bg-gray-700">+</button>
                              <button (click)="removePdvCartItem($index)" class="text-xs text-red-400 ml-2">x</button>
                            </div>
                          </div>
                          <p class="text-sm font-semibold">{{item.total_price | currency:'BRL'}}</p>
                      </div>
                    }
                    @if (pdvCart().length === 0) { <p class="text-center text-gray-500 text-sm">O carrinho est치 vazio</p> }
                  </div>
                  <div class="border-t border-gray-700 pt-4">
                    <div class="space-y-1 mb-4 text-sm">
                      <p class="flex justify-between"><span>Subtotal:</span> <span>{{pdvSubtotal() | currency:'BRL'}}</span></p>
                      @if (pdvState() === 'delivery') {
                        <p class="flex justify-between"><span>Taxa de Entrega:</span> <span>{{pdvDeliveryFee() | currency:'BRL'}}</span></p>
                      }
                      <p class="flex justify-between font-bold text-lg"><span>Total:</span> <span class="text-purple-400">{{pdvTotal() | currency:'BRL'}}</span></p>
                    </div>

                    <form [formGroup]="pdvCheckoutForm" (ngSubmit)="finalizePdvOrder()" class="space-y-3">
                      <input formControlName="customer_name" placeholder="Nome do Cliente" class="w-full bg-gray-700 p-2 rounded text-sm">
                      <input formControlName="phone" placeholder="Telefone do Cliente (WhatsApp)" class="w-full bg-gray-700 p-2 rounded text-sm">

                      @if (pdvState() === 'delivery') {
                        <div class="border border-gray-700 p-3 rounded-lg space-y-3">
                          <p class="text-xs text-yellow-400">Dados para Entrega</p>
                           <div class="grid grid-cols-3 gap-2">
                              <div class="col-span-2"><input formControlName="street" placeholder="Rua / Avenida" class="w-full bg-gray-600 p-2 rounded text-sm"></div>
                              <div><input formControlName="number" placeholder="N췈" class="w-full bg-gray-600 p-2 rounded text-sm"></div>
                          </div>
                           @if (dataService.settings().delivery.type === 'neighborhood') {
                              <select formControlName="neighborhood" class="w-full bg-gray-600 p-2 rounded text-sm">
                                  <option value="">Selecione o bairro</option>
                                  @for (hood of dataService.settings().delivery.neighborhoods; track hood.name) { <option [value]="hood.name">{{ hood.name }}</option> }
                              </select>
                           } @else {
                              <input formControlName="neighborhood" placeholder="Bairro" class="w-full bg-gray-600 p-2 rounded text-sm">
                           }
                        </div>
                      }
                      
                      <select formControlName="payment_method" class="w-full bg-gray-700 p-2 rounded text-sm">
                          <option value="cash">Dinheiro</option>
                          <option value="card">Cart칚o</option>
                          <option value="pix-machine">PIX (Maquininha)</option>
                          <option value="credit">A Receber (Fiado)</option>
                      </select>
                      @if(pdvCheckoutForm.get('payment_method')?.value === 'cash') {
                          <input type="number" formControlName="change_for" placeholder="Troco para quanto?" class="w-full bg-gray-600 p-2 rounded text-sm">
                      }

                      @if(pdvCheckoutForm.get('payment_method')?.value === 'credit') {
                          <div class="border border-gray-700 p-3 rounded-lg space-y-3">
                              <p class="text-xs text-yellow-400">Para "Fiado", todos os campos s칚o obrigat칩rios.</p>
                              <input formControlName="address" placeholder="Endere칞o Completo" class="w-full bg-gray-600 p-2 rounded text-sm">
                              <div>
                                  <label class="block text-xs text-gray-400 mb-1">Data para Pagamento</label>
                                  <input type="date" formControlName="payment_due_date" class="w-full bg-gray-600 p-2 rounded text-sm">
                              </div>
                          </div>
                      }
                      <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">
                        {{ pdvState() === 'delivery' ? 'Criar Pedido de Entrega' : 'Finalizar Venda' }}
                      </button>
                       <button type="button" (click)="cancelPdvOrder()" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded-lg text-sm">Cancelar Pedido</button>
                    </form>
                  </div>
                </div>
              </div>
            }
          }
           @case('sales') {
            <div class="bg-gray-900 p-6 rounded-lg">
              <h2 class="text-2xl font-semibold mb-6">Hist칩rico de Vendas</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-800 p-4 rounded-lg text-center">
                  <p class="text-sm text-gray-400">Faturamento Total</p>
                  <p class="text-2xl font-bold text-green-400">{{ totalSales() | currency:'BRL' }}</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg text-center">
                  <p class="text-sm text-gray-400">Total de Pedidos</p>
                  <p class="text-2xl font-bold text-purple-400">{{ dataService.orders().length }}</p>
                </div>
              </div>
              <div class="space-y-2">
                @for(order of dataService.orders(); track order.id) {
                  <div class="bg-gray-800 p-3 rounded-lg text-sm">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                      <p><b>#{{order.id.slice(-4)}}</b> - {{order.customer_name}}</p>
                      <p><span class="text-gray-400">Total:</span> {{order.total | currency:'BRL'}}</p>
                      <p><span class="text-gray-400">Data:</span> {{order.date | date:'dd/MM/yy HH:mm'}}</p>
                      <p><span class="text-gray-400">Status:</span> <span class="font-semibold" [class.text-green-400]="order.status === 'Entregue'" [class.text-red-400]="order.status === 'Cancelado'">{{order.status}}</span></p>
                    </div>
                  </div>
                }
                 @if (dataService.orders().length === 0) { <p class="text-center text-gray-500">Nenhuma venda registrada.</p> }
              </div>
            </div>
          }
          @case('accounts') {
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Accounts Receivable -->
                <div class="bg-gray-900 p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4">Contas a Receber</h2>
                    <div class="space-y-3 max-h-[70vh] overflow-y-auto">
                      @for(receivable of sortedReceivables(); track receivable.id) {
                        <div class="bg-gray-800 p-3 rounded-lg border-l-4" [class.border-yellow-400]="receivable.status === 'pending'" [class.border-green-400]="receivable.status === 'paid'">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold">{{receivable.customer_name}} - <span class="text-purple-400">{{receivable.amount | currency:'BRL'}}</span></p>
                                    <p class="text-xs text-gray-400">Pedido: #{{receivable.order_id.slice(-4)}}</p>
                                    <p class="text-xs text-gray-400">Vencimento: {{receivable.payment_due_date | date:'dd/MM/yyyy'}}</p>
                                </div>
                                @if(receivable.status === 'pending') {
                                    <button (click)="markReceivableAsPaid(receivable.id)" class="text-xs bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-2 rounded">Marcar como Pago</button>
                                } @else {
                                    <p class="text-xs font-bold text-green-400">PAGO</p>
                                }
                            </div>
                        </div>
                      }
                      @if (sortedReceivables().length === 0) { <p class="text-center text-gray-500 py-4">Nenhuma conta a receber.</p> }
                    </div>
                </div>
                <!-- Expenses -->
                <div class="bg-gray-900 p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4">Despesas e Sa칤das</h2>
                    <form [formGroup]="expenseForm" (ngSubmit)="saveExpense()" class="space-y-3 bg-gray-800 p-4 rounded-lg mb-6">
                        <input type="text" formControlName="description" placeholder="Descri칞칚o da despesa" class="w-full bg-gray-700 p-2 rounded text-sm">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" formControlName="amount" placeholder="Valor (R$)" class="w-full bg-gray-700 p-2 rounded text-sm">
                            <input type="date" formControlName="date" class="w-full bg-gray-700 p-2 rounded text-sm">
                        </div>
                        <div class="flex justify-end space-x-2">
                           @if(editingExpense()) {
                             <button type="button" (click)="cancelEditExpense()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded-lg text-sm">Cancelar</button>
                           }
                           <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm">{{ editingExpense() ? 'Salvar Altera칞칚o' : 'Adicionar Despesa' }}</button>
                        </div>
                    </form>
                     <div class="space-y-3 max-h-[45vh] overflow-y-auto">
                        @for(expense of sortedExpenses(); track expense.id) {
                           <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                               <div>
                                   <p>{{expense.description}} - <span class="font-semibold text-red-400">{{expense.amount | currency:'BRL'}}</span></p>
                                   <p class="text-xs text-gray-400">{{expense.date | date:'dd/MM/yyyy'}}</p>
                               </div>
                               <div class="space-x-2">
                                   <button (click)="editExpense(expense)" class="text-xs text-blue-400">Editar</button>
                                   <button (click)="deleteExpense(expense.id)" class="text-xs text-red-400">Excluir</button>
                               </div>
                           </div>
                        }
                        @if(sortedExpenses().length === 0) { <p class="text-center text-gray-500 py-4">Nenhuma despesa registrada.</p> }
                     </div>
                </div>
             </div>
          }
          @case ('products') {
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2 bg-gray-900 p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-2xl font-semibold">Produtos</h2>
                  <button (click)="editProduct(null)" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Novo Produto</button>
                </div>

                @if(!editingProduct()) {
                  <div class="space-y-3">
                  @for(product of sortedProducts(); track product.id; let i = $index) {
                    <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                      <div class="flex items-center space-x-4">
                        <div class="flex flex-col">
                           <button (click)="moveItem('products', i, 'up')" class="disabled:opacity-25" [disabled]="i === 0">&#9650;</button>
                           <button (click)="moveItem('products', i, 'down')" class="disabled:opacity-25" [disabled]="i === sortedProducts().length - 1">&#9660;</button>
                        </div>
                        <img [src]="product.image_url || 'https://via.placeholder.com/50'" class="w-12 h-12 rounded object-cover">
                        <div>
                           <p class="font-semibold">{{product.name}}</p>
                           <p class="text-xs text-gray-400">{{getCategoryName(product.category_id)}}</p>
                        </div>
                      </div>
                      <div class="space-x-2"><button (click)="editProduct(product)" class="text-sm text-blue-400">Editar</button><button (click)="deleteProduct(product.id)" class="text-sm text-red-400">Excluir</button></div>
                    </div>
                  }
                  </div>
                } @else {
                  <form [formGroup]="productForm" (ngSubmit)="saveProduct()" class="space-y-4">
                    <input type="hidden" formControlName="id">
                     <div class="flex items-center justify-between bg-gray-800 p-3 rounded-lg">
                      <label for="productAvailable" class="text-sm font-medium">Produto Dispon칤vel</label>
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" formControlName="is_available" id="productAvailable" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                      </label>
                    </div>
                    <div><label class="block text-sm">Nome</label><input formControlName="name" class="w-full bg-gray-700 p-2 rounded"></div>
                    <div>
                      <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm">Descri칞칚o</label>
                        <button type="button" (click)="generateDescription()" [disabled]="isGeneratingDescription()" class="text-xs bg-purple-600 hover:bg-purple-700 disabled:bg-purple-900 disabled:cursor-wait text-white font-bold py-1 px-2 rounded-lg flex items-center space-x-1">
                          @if (isGeneratingDescription()) {
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span>Gerando...</span>
                          } @else {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
                            <span>Gerar com IA</span>
                          }
                        </button>
                      </div>
                      <textarea formControlName="description" class="w-full bg-gray-700 p-2 rounded" rows="3"></textarea>
                    </div>
                    <div>
                      <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm">Imagem</label>
                         <button type="button" (click)="generateImage()" [disabled]="isGeneratingImage()" class="text-xs bg-purple-600 hover:bg-purple-700 disabled:bg-purple-900 disabled:cursor-wait text-white font-bold py-1 px-2 rounded-lg flex items-center space-x-1">
                          @if (isGeneratingImage()) {
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span>Gerando...</span>
                          } @else {
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
                            <span>Gerar com IA</span>
                          }
                        </button>
                      </div>
                       @if (productForm.get('image_url')?.value) {
                        <img [src]="productForm.get('image_url')?.value" alt="Preview da imagem" class="w-full h-40 object-cover rounded-lg my-2 bg-gray-800">
                      }
                      <input type="file" (change)="onProductFileChange($event)" class="w-full text-sm text-gray-400 file:bg-gray-600 file:border-0 file:px-4 file:py-2 file:rounded-lg file:mr-4">
                    </div>
                    <div><label class="block text-sm">Categoria</label><select formControlName="category_id" class="w-full bg-gray-700 p-2 rounded"> @for(cat of sortedCategories(); track cat.id) { <option [value]="cat.id">{{cat.name}}</option> } </select></div>
                    
                    <div>
                      <label class="block text-sm mb-1">Tipo de Pre칞o</label>
                      <div class="flex space-x-4 p-2 bg-gray-800 rounded-md">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" formControlName="price_type" value="sized" class="form-radio h-4 w-4 bg-gray-700 text-purple-600">
                            <span class="ml-2 text-sm">Por Tamanho</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" formControlName="price_type" value="fixed" class="form-radio h-4 w-4 bg-gray-700 text-purple-600">
                            <span class="ml-2 text-sm">Pre칞o Fixo</span>
                        </label>
                      </div>
                    </div>

                    @if (productForm.get('price_type')?.value === 'fixed') {
                      <div>
                        <label class="block text-sm">Pre칞o Fixo (R$)</label>
                        <input type="number" formControlName="price" class="w-full bg-gray-700 p-2 rounded">
                      </div>
                    } @else {
                      <div formArrayName="sizes" class="space-y-2"><label class="block text-sm">Tamanhos</label>
                        @for(size of productSizes.controls; track $index) {
                          <div [formGroupName]="$index" class="flex items-center space-x-2 bg-gray-800 p-2 rounded">
                            <input formControlName="name" placeholder="Nome (Ex: 500ml)" class="flex-grow bg-gray-700 p-1 rounded"><input type="number" formControlName="price" placeholder="Pre칞o" class="w-24 bg-gray-700 p-1 rounded">
                            <label class="flex items-center cursor-pointer space-x-1">
                              <input type="checkbox" formControlName="is_available" class="form-checkbox h-4 w-4 bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500 rounded">
                              <span class="text-xs text-gray-400">Disp.</span>
                            </label>
                            <button type="button" (click)="removeProductSize($index)" class="text-red-500">X</button>
                          </div>
                        }
                        <button type="button" (click)="addProductSize()" class="text-sm text-purple-400">+ Adicionar Tamanho</button>
                      </div>
                    }

                    <div>
                      <label class="block text-sm mb-1">Categorias de Adicionais</label>
                      <div class="space-y-2 p-3 rounded bg-gray-800 border border-gray-700 max-h-48 overflow-y-auto">
                        @for(ac of sortedAddonCategories(); track ac.id) {
                          <label class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   [checked]="isAddonCategorySelected(ac.id)"
                                   (change)="onAddonCategoryChange($event, ac.id)"
                                   class="form-checkbox h-4 w-4 bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500 rounded">
                            <span class="ml-2 text-sm">{{ac.name}}</span>
                          </label>
                        }
                        @if (sortedAddonCategories().length === 0) {
                          <p class="text-xs text-gray-500">Nenhuma categoria de adicional cadastrada.</p>
                        }
                      </div>
                    </div>

                    <div class="flex space-x-2"><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button><button type="button" (click)="editingProduct.set(null)" class="bg-gray-600 hover:bg-gray-500 py-2 px-4 rounded-lg">Cancelar</button></div>
                  </form>
                }
              </div>

              <div class="space-y-6">
                <div class="bg-gray-900 p-6 rounded-lg">
                  <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Categorias</h3><button (click)="editCategory(null)" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Nova</button></div>
                   @if(!editingCategory()) {
                    <div class="space-y-2">
                      @for(cat of sortedCategories(); track cat.id; let i = $index) {
                        <div class="bg-gray-800 p-2 rounded-lg flex justify-between items-center">
                           <div class="flex items-center space-x-2">
                             <div class="flex flex-col"><button (click)="moveItem('categories', i, 'up')" [disabled]="i === 0">&#9650;</button><button (click)="moveItem('categories', i, 'down')" [disabled]="i === sortedCategories().length - 1">&#9660;</button></div>
                             <p>{{cat.name}}</p>
                           </div>
                          <div class="space-x-2"><button (click)="editCategory(cat)" class="text-xs text-blue-400">Editar</button><button (click)="deleteCategory(cat.id)" class="text-xs text-red-400">Excluir</button></div>
                        </div>
                      }
                    </div>
                   } @else {
                     <form [formGroup]="categoryForm" (ngSubmit)="saveCategory()" class="space-y-2"><input formControlName="name" class="w-full bg-gray-700 p-2 rounded"><div class="flex space-x-2"><button type="submit" class="bg-green-600 text-sm py-1 px-2 rounded">Salvar</button><button type="button" (click)="editCategory(null)" class="bg-gray-600 text-sm py-1 px-2 rounded">Cancelar</button></div></form>
                   }
                </div>
                <div class="bg-gray-900 p-6 rounded-lg">
                  <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Grupos de Adicionais</h3><button (click)="editAddonCategory(null)" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Novo</button></div>
                  @if(!editingAddonCategory()) {
                    <div class="space-y-2">
                      @for(ac of sortedAddonCategories(); track ac.id; let i = $index) {
                        <div class="bg-gray-800 p-2 rounded-lg">
                          <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-2">
                              <div class="flex flex-col"><button (click)="moveItem('addonCategories', i, 'up')" [disabled]="i === 0">&#9650;</button><button (click)="moveItem('addonCategories', i, 'down')" [disabled]="i === sortedAddonCategories().length - 1">&#9660;</button></div>
                              <p>{{ac.name}}</p>
                            </div>
                            <div class="space-x-2"><button (click)="editAddonCategory(ac)" class="text-xs text-blue-400">Editar</button><button (click)="deleteAddonCategory(ac.id)" class="text-xs text-red-400">Excluir</button></div>
                          </div>
                        </div>
                      }
                    </div>
                  } @else {
                     <form [formGroup]="addonCategoryForm" (ngSubmit)="saveAddonCategory()" class="space-y-4">
                        <div><label class="block text-sm">Nome do Grupo</label><input formControlName="name" class="w-full bg-gray-700 p-2 rounded"></div>
                        <div class="flex items-center"><input type="checkbox" formControlName="required" id="addonRequired" class="form-checkbox h-4 w-4 bg-gray-800 text-purple-600"><label for="addonRequired" class="ml-2 text-sm">Obrigat칩rio</label></div>
                        <div formArrayName="addons" class="space-y-2"><label class="block text-sm">Itens Adicionais</label>
                           @for(addon of addonCategoryAddons.controls; track $index) {
                             <div [formGroupName]="$index" class="flex items-center space-x-2 bg-gray-800 p-1 rounded">
                                <input formControlName="name" placeholder="Nome" class="w-full bg-gray-700 p-1 rounded"><input type="number" formControlName="price" placeholder="Pre칞o" class="w-24 bg-gray-700 p-1 rounded">
                                <label class="flex items-center cursor-pointer space-x-1">
                                  <input type="checkbox" formControlName="is_available" class="form-checkbox h-4 w-4 bg-gray-700 border-gray-600 text-purple-600 focus:ring-purple-500 rounded">
                                  <span class="text-xs text-gray-400">Disp.</span>
                                </label>
                                <button type="button" (click)="removeAddonFromAddonCategory($index)" class="text-red-500 text-xs">X</button>
                             </div>
                           }
                           <button type="button" (click)="addAddonToAddonCategory()" class="text-sm text-purple-400">+ Adicionar Item</button>
                        </div>
                        <div class="flex space-x-2"><button type="submit" class="bg-green-600 text-sm py-1 px-2 rounded">Salvar</button><button type="button" (click)="editAddonCategory(null)" class="bg-gray-600 text-sm py-1 px-2 rounded">Cancelar</button></div>
                     </form>
                  }
                </div>
              </div>
            </div>
          }
          @case ('drivers') {
            <div class="bg-gray-900 p-6 rounded-lg">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold">Entregadores</h2>
                    <div class="flex space-x-1 rounded-lg p-1 bg-gray-800">
                        <button (click)="driverView.set('management')" class="px-3 py-1 text-sm font-medium rounded-md" [class.bg-purple-600]="driverView() === 'management'" [class.text-gray-300]="driverView() !== 'management'">Gerenciar Cadastros</button>
                        <button (click)="driverView.set('reports')" class="px-3 py-1 text-sm font-medium rounded-md" [class.bg-purple-600]="driverView() === 'reports'" [class.text-gray-300]="driverView() !== 'reports'">Relat칩rios de Entregas</button>
                    </div>
                </div>

                @if (driverView() === 'management') {
                  <div class="space-y-8">
                      <!-- Pending Registrations -->
                      <div>
                          <h3 class="text-xl font-semibold mb-4 text-yellow-400">Cadastros Pendentes</h3>
                          @if (pendingDrivers().length > 0) {
                              <div class="space-y-4">
                                  @for (driver of pendingDrivers(); track driver.id) {
                                      <div class="bg-gray-800 p-4 rounded-lg">
                                          <p class="font-bold text-lg">{{ driver.name }}</p>
                                          <div class="text-sm text-gray-300 mt-2 space-y-1">
                                              <p><span class="font-semibold text-gray-400">WhatsApp:</span> {{ driver.whatsapp }}</p>
                                              <p><span class="font-semibold text-gray-400">Endere칞o:</span> {{ driver.address }}</p>
                                              <p><span class="font-semibold text-gray-400">CNH:</span> {{ driver.cnh }}</p>
                                          </div>
                                          <div class="mt-4 flex space-x-2">
                                              <button (click)="approveDriver(driver.id)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Aprovar</button>
                                              <button (click)="declineDriver(driver.id)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Recusar</button>
                                          </div>
                                      </div>
                                  }
                              </div>
                          } @else {
                              <p class="text-gray-500">Nenhum cadastro pendente no momento.</p>
                          }
                      </div>

                      <!-- Approved Drivers -->
                      <div>
                          <h3 class="text-xl font-semibold mb-4 text-green-400">Entregadores Aprovados</h3>
                          @if(approvedDrivers().length > 0) {
                            <div class="space-y-3">
                              @for (driver of approvedDrivers(); track driver.id) {
                                  <div class="bg-gray-800 p-3 rounded-lg">
                                      <p class="font-semibold">{{ driver.name }}</p>
                                      <p class="text-xs text-gray-400">WhatsApp: {{ driver.whatsapp }}</p>
                                      <div class="mt-4 flex space-x-2">
                                          <button (click)="blockDriver(driver.id)" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Bloquear</button>
                                          <button (click)="banDriver(driver.id)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Banir</button>
                                      </div>
                                  </div>
                              }
                            </div>
                          } @else {
                            <p class="text-gray-500">Nenhum entregador aprovado.</p>
                          }
                      </div>

                      <!-- Blocked Drivers -->
                      <div>
                          <h3 class="text-xl font-semibold mb-4 text-orange-400">Entregadores Bloqueados</h3>
                          @if(blockedDrivers().length > 0) {
                            <div class="space-y-3">
                              @for (driver of blockedDrivers(); track driver.id) {
                                  <div class="bg-gray-800 p-3 rounded-lg opacity-80">
                                      <p class="font-semibold">{{ driver.name }}</p>
                                      <p class="text-xs text-gray-400">WhatsApp: {{ driver.whatsapp }}</p>
                                      <div class="mt-4 flex space-x-2">
                                          <button (click)="unblockDriver(driver.id)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Desbloquear</button>
                                          <button (click)="banDriver(driver.id)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Banir</button>
                                      </div>
                                  </div>
                              }
                            </div>
                          } @else {
                            <p class="text-gray-500">Nenhum entregador bloqueado.</p>
                          }
                      </div>

                       <!-- Declined Drivers -->
                      <div>
                          <h3 class="text-xl font-semibold mb-4 text-red-400">Entregadores Recusados</h3>
                           @if(declinedDrivers().length > 0) {
                            <div class="space-y-3">
                              @for (driver of declinedDrivers(); track driver.id) {
                                  <div class="bg-gray-800 p-3 rounded-lg opacity-60">
                                      <p class="font-semibold">{{ driver.name }}</p>
                                       <p class="text-xs text-gray-400">WhatsApp: {{ driver.whatsapp }}</p>
                                       <div class="mt-4 flex space-x-2">
                                          <button (click)="approveDriver(driver.id)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Aprovar</button>
                                          <button (click)="banDriver(driver.id)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Banir</button>
                                      </div>
                                  </div>
                              }
                            </div>
                          } @else {
                             <p class="text-gray-500">Nenhum entregador recusado.</p>
                          }
                      </div>
                  </div>
                } @else if (driverView() === 'reports') {
                    <div>
                        <div class="mb-6">
                            <label for="driver-select" class="block text-sm font-medium text-gray-300 mb-1">Selecione um Entregador</label>
                            <select id="driver-select" (change)="selectDriverForReport($event)" class="w-full max-w-xs bg-gray-700 border-gray-600 rounded-md p-2 focus:ring-purple-500 focus:border-purple-500">
                                <option value="">-- Escolha um entregador --</option>
                                @for(driver of approvedDrivers(); track driver.id) {
                                    <option [value]="driver.id">{{ driver.name }}</option>
                                }
                            </select>
                        </div>

                        @if (selectedDriverForReport(); as driver) {
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <!-- Left Column: Summary and Payments -->
                                <div class="lg:col-span-1 space-y-6">
                                    <div class="bg-gray-800 p-4 rounded-lg">
                                        <h3 class="text-lg font-semibold mb-3">Resumo Financeiro de {{ driver.name }}</h3>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between"><span>Total de Entregas:</span> <span class="font-semibold">{{ reportDeliveries().length }}</span></div>
                                            <div class="flex justify-between"><span>Total em Taxas:</span> <span class="font-semibold text-green-400">{{ reportTotals().totalFees | currency:'BRL' }}</span></div>
                                            <div class="flex justify-between"><span>Total Pago:</span> <span class="font-semibold text-red-400">-{{ reportTotals().totalPaid | currency:'BRL' }}</span></div>
                                            <div class="flex justify-between text-base font-bold border-t border-gray-700 mt-2 pt-2"><span>SALDO A PAGAR:</span> <span class="text-yellow-400">{{ reportTotals().balance | currency:'BRL' }}</span></div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-gray-800 p-4 rounded-lg">
                                        <h3 class="text-lg font-semibold mb-3">Registrar Pagamento</h3>
                                        <form [formGroup]="driverPaymentForm" (ngSubmit)="saveDriverPayment()" class="space-y-3">
                                            <input type="number" formControlName="amount" placeholder="Valor Pago (R$)" class="w-full bg-gray-700 p-2 rounded text-sm">
                                            <input type="date" formControlName="payment_date" class="w-full bg-gray-700 p-2 rounded text-sm">
                                            <input type="text" formControlName="notes" placeholder="Notas (Ex: Pag. semana 1)" class="w-full bg-gray-700 p-2 rounded text-sm">
                                            <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg text-sm">Registrar</button>
                                        </form>
                                    </div>

                                    <div class="bg-gray-800 p-4 rounded-lg">
                                        <h3 class="text-lg font-semibold mb-3">Pagamentos Realizados</h3>
                                        <div class="space-y-2 max-h-60 overflow-y-auto">
                                            @for(payment of reportPayments(); track payment.id) {
                                                <div class="text-sm p-2 bg-gray-700 rounded-md">
                                                    <div class="flex justify-between">
                                                        <span class="font-bold text-green-400">{{ payment.amount | currency:'BRL' }}</span>
                                                        <span class="text-xs text-gray-400">{{ payment.payment_date | date:'dd/MM/yy' }}</span>
                                                    </div>
                                                    @if(payment.notes) {
                                                        <p class="text-xs text-gray-300 mt-1">{{ payment.notes }}</p>
                                                    }
                                                </div>
                                            }
                                            @if (reportPayments().length === 0) {
                                                <p class="text-sm text-gray-500">Nenhum pagamento registrado.</p>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column: Deliveries List -->
                                <div class="lg:col-span-2 bg-gray-800 p-4 rounded-lg">
                                    <h3 class="text-lg font-semibold mb-3">Entregas Realizadas</h3>
                                    <div class="space-y-2 max-h-[80vh] overflow-y-auto">
                                        @for(delivery of reportDeliveries(); track delivery.id) {
                                            <div class="text-sm p-2 bg-gray-700 rounded-md flex justify-between">
                                                <div>
                                                    <p>Pedido <span class="font-mono">#{{ delivery.id.slice(-4) }}</span></p>
                                                    <p class="text-xs text-gray-400">{{ delivery.date | date:'dd/MM/yy HH:mm' }}</p>
                                                </div>
                                                <div class="font-semibold text-green-400">
                                                    +{{ delivery.delivery_fee | currency:'BRL' }}
                                                </div>
                                            </div>
                                        }
                                        @if (reportDeliveries().length === 0) {
                                            <p class="text-sm text-gray-500">Nenhuma entrega finalizada encontrada para este entregador.</p>
                                        }
                                    </div>
                                </div>
                            </div>
                        } @else {
                            <p class="text-center text-gray-500 py-10">Selecione um entregador para ver seu relat칩rio.</p>
                        }
                    </div>
                }
            </div>
          }
          @case ('settings') {
            <div class="bg-gray-900 p-6 rounded-lg">
              <h2 class="text-2xl font-semibold mb-4">Configura칞칫es da Loja</h2>
              <form [formGroup]="mainSettingsForm" (ngSubmit)="saveMainSettings()" class="space-y-6 max-w-2xl">
                
                <div class="space-y-4 bg-gray-800 p-4 rounded-lg">
                    <h3 class="font-semibold">Credenciais de Administrador</h3>
                    <p class="text-sm text-gray-400">Use isso para alterar o acesso ao painel administrativo.</p>
                    <div>
                        <label class="block text-sm mb-1">Nome de Usu치rio</label>
                        <input formControlName="admin_username" class="w-full bg-gray-700 p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm mb-1">Nova Senha (deixe em branco para n칚o alterar)</label>
                        <input type="password" formControlName="admin_password" class="w-full bg-gray-700 p-2 rounded" placeholder="뮉뮉뮉뮉뮉뮉뮉">
                    </div>
                </div>

                <div><label class="block text-sm mb-1">Nome da Loja</label><input formControlName="name" class="w-full bg-gray-700 p-2 rounded"></div>
                <div><label class="block text-sm mb-1">Endere칞o</label><input formControlName="address" class="w-full bg-gray-700 p-2 rounded"></div>
                 <div>
                    <label class="block text-sm mb-1">Mensagem de Boas-vindas</label>
                    <textarea formControlName="welcome_message" class="w-full bg-gray-700 p-2 rounded" rows="3" placeholder="Uma mensagem que aparecer치 no topo do card치pio"></textarea>
                </div>
                 <div>
                    <label class="block text-sm mb-1">Tempo de Espera Estimado</label>
                    <input formControlName="wait_time" class="w-full bg-gray-700 p-2 rounded" placeholder="Ex: 30-50 min">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div><label class="block text-sm mb-1">WhatsApp da Loja</label><input formControlName="whatsapp" class="w-full bg-gray-700 p-2 rounded"></div>
                  <div><label class="block text-sm mb-1">WhatsApp do Entregador</label><input formControlName="delivery_whatsapp" class="w-full bg-gray-700 p-2 rounded"></div>
                  <div><label class="block text-sm mb-1">Instagram URL</label><input formControlName="instagram" class="w-full bg-gray-700 p-2 rounded"></div>
                </div>
                 <div class="space-y-4 bg-gray-800 p-4 rounded-lg" formGroupName="opening_hours">
                    <h3 class="font-semibold">Hor치rio de Funcionamento</h3>
                    @for(day of weekDays; track day) {
                       <div [formGroupName]="day" class="grid grid-cols-1 sm:grid-cols-3 gap-y-2 sm:gap-x-4 items-center">
                           <label class="flex items-center"><input type="checkbox" formControlName="is_open" class="form-checkbox h-4 w-4 bg-gray-700 text-purple-600 mr-2">{{ weekDayNames[day] }}</label>
                           <input type="time" formControlName="start" class="bg-gray-700 p-1 rounded" [disabled]="!openingHoursControls[day].value.is_open">
                           <input type="time" formControlName="end" class="bg-gray-700 p-1 rounded" [disabled]="!openingHoursControls[day].value.is_open">
                       </div>
                    }
                 </div>
                <div class="space-y-4 bg-gray-800 p-4 rounded-lg">
                  <h3 class="font-semibold">Fechamento Tempor치rio</h3>
                  <p class="text-sm text-gray-400">Use para fechar a loja imediatamente, independente do hor치rio de funcionamento. A mensagem ser치 exibida para os clientes no card치pio.</p>
                  <div class="flex items-center space-x-4">
                      <button type="button" (click)="toggleTemporaryClosure()" 
                              class="font-bold py-2 px-4 rounded-lg"
                              [class.bg-red-600]="!mainSettingsForm.get('is_temporarily_closed')?.value"
                              [class.hover:bg-red-700]="!mainSettingsForm.get('is_temporarily_closed')?.value"
                              [class.bg-green-600]="mainSettingsForm.get('is_temporarily_closed')?.value"
                              [class.hover:bg-green-700]="mainSettingsForm.get('is_temporarily_closed')?.value">
                          {{ mainSettingsForm.get('is_temporarily_closed')?.value ? 'ABRIR LOJA' : 'FECHAR LOJA' }}
                      </button>
                      @if(mainSettingsForm.get('is_temporarily_closed')?.value) {
                          <span class="text-red-400 font-bold">LOJA FECHADA</span>
                      }
                  </div>
                  <div>
                      <label class="block text-sm mb-1">Mensagem de Fechamento</label>
                      <input formControlName="temporary_closure_message" class="w-full bg-gray-700 p-2 rounded">
                  </div>
                </div>
                <div formGroupName="delivery" class="space-y-4 bg-gray-800 p-4 rounded-lg">
                  <h3 class="font-semibold">Taxa de Entrega</h3>
                  <div class="flex space-x-4">
                      <label class="flex items-center"><input type="radio" formControlName="type" value="fixed" class="form-radio h-4 w-4 text-purple-600"><span class="ml-2">Taxa Fixa</span></label>
                      <label class="flex items-center"><input type="radio" formControlName="type" value="neighborhood" class="form-radio h-4 w-4 text-purple-600"><span class="ml-2">Por Bairro</span></label>
                  </div>
                  @if (mainSettingsForm.get('delivery.type')?.value === 'fixed') {
                    <div><label class="block text-sm mb-1">Valor da Taxa Fixa</label><input type="number" formControlName="fixed_fee" class="w-full bg-gray-700 p-2 rounded"></div>
                  } @else {
                    <div formArrayName="neighborhoods" class="space-y-2"><label class="block text-sm">Bairros e Taxas</label>
                      @for(hood of deliveryNeighborhoods.controls; track $index) {
                        <div [formGroupName]="$index" class="flex items-center space-x-2 bg-gray-700 p-2 rounded">
                          <input formControlName="name" placeholder="Nome do Bairro" class="w-full bg-gray-600 p-1 rounded"><input type="number" formControlName="fee" placeholder="Taxa" class="w-32 bg-gray-600 p-1 rounded">
                          <button type="button" (click)="removeNeighborhood($index)" class="text-red-500 font-bold">X</button>
                        </div>
                      }
                      <button type="button" (click)="addNeighborhood()" class="text-sm text-purple-400 hover:text-purple-300">+ Adicionar Bairro</button>
                    </div>
                  }
                </div>

                <div><label class="block text-sm mb-1">Chave PIX</label><input formControlName="pix_key" class="w-full bg-gray-700 p-2 rounded"></div>
                <div><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Configura칞칫es</button></div>
              </form>
            </div>
          }
          @case('layout') {
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Controls -->
              <div class="bg-gray-900 p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4">Apar칡ncia da Loja</h2>
                <form [formGroup]="mainSettingsForm" (ngSubmit)="saveMainSettings()" class="space-y-6">
                  <div formGroupName="layout" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      @for(color of ['primary_color', 'accent_color', 'background_color', 'text_color', 'card_color']; track color) {
                        <div class="flex items-center space-x-3">
                          <input type="color" [formControlName]="color" class="w-10 h-10 p-0.5 bg-gray-700 border-gray-600 rounded-md cursor-pointer">
                          <label class="text-sm">{{ colorNames[color] }}</label>
                        </div>
                      }
                    </div>
                  </div>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t border-gray-700">
                    <div>
                      <label class="block text-sm mb-1">Logo da Loja</label>
                      <input type="file" (change)="onFileChange($event, 'logo_url')" class="w-full text-sm text-gray-400 file:bg-gray-700 file:border-0 file:px-3 file:py-2 file:rounded-md file:mr-4">
                    </div>
                    <div>
                      <label class="block text-sm mb-1">Banner da Loja</label>
                      <input type="file" (change)="onFileChange($event, 'banner_url')" class="w-full text-sm text-gray-400 file:bg-gray-700 file:border-0 file:px-3 file:py-2 file:rounded-md file:mr-4">
                    </div>
                     <div>
                        <label class="block text-sm mb-1">Imagem de Fundo do PDV</label>
                        <input type="file" (change)="onFileChange($event, 'pdv_background_image_url')" class="w-full text-sm text-gray-400 file:bg-gray-700 file:border-0 file:px-3 file:py-2 file:rounded-md file:mr-4">
                    </div>
                  </div>
                  <div class="pt-4 border-t border-gray-700">
                      <h3 class="text-lg font-semibold mb-2">Carrossel de Imagens da Tela Inicial</h3>
                      <div formArrayName="slider_images" class="space-y-4">
                          @for(imageControl of sliderImages.controls; track $index) {
                            <div class="flex items-center space-x-4 bg-gray-800 p-2 rounded-lg">
                                <img [src]="imageControl.value || 'https://via.placeholder.com/100x56'" class="w-24 h-14 object-cover rounded">
                                <div class="flex-grow">
                                    <input type="file" (change)="onSliderFileChange($event, $index)" class="w-full text-sm text-gray-400 file:bg-gray-700 file:border-0 file:px-3 file:py-2 file:rounded-md file:mr-4">
                                </div>
                                <button type="button" (click)="removeSliderImage($index)" class="text-red-500 font-bold p-2 rounded-full hover:bg-red-500/20">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                                </button>
                            </div>
                          }
                          <button type="button" (click)="addSliderImage()" class="text-sm text-purple-400 hover:text-purple-300">+ Adicionar Nova Imagem</button>
                      </div>
                  </div>
                  <div>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Apar칡ncia</button>
                  </div>
                </form>
              </div>

              <!-- Preview -->
              <div class="bg-gray-900 p-2 rounded-lg">
                <h3 class="text-lg font-semibold mb-2 text-center text-gray-400">Pr칠-visualiza칞칚o Interativa</h3>
                <div class="w-full h-[500px] rounded-md overflow-hidden scale-100 border-4 border-gray-700">
                  @if (mainSettingsForm.get('layout')?.value) {
                    <app-layout-preview [layout]="mainSettingsForm.get('layout')!.value"></app-layout-preview>
                  }
                </div>
              </div>
            </div>
          }
          @case('coupons') {
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-gray-900 p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Cupons de Desconto</h2>
                    <button (click)="editCoupon(null)" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Novo Cupom</button>
                </div>
                
                @if(!editingCoupon()) {
                    <div class="space-y-3">
                        @for(coupon of sortedCoupons(); track coupon.id) {
                            <div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-purple-400">{{coupon.code}}</p>
                                    <p class="text-sm">{{coupon.description}}</p>
                                    <p class="text-xs text-gray-400">{{ coupon.discount_type === 'free_shipping' ? 'Frete Gr치tis' : coupon.discount_type === 'percentage' ? coupon.discount_value + '%' : (coupon.discount_value | currency:'BRL') }} de desconto</p>
                                </div>
                                <div class="space-x-2">
                                    <button (click)="editCoupon(coupon)" class="text-sm text-blue-400">Editar</button>
                                    <button (click)="deleteCoupon(coupon.id)" class="text-sm text-red-400">Excluir</button>
                                </div>
                            </div>
                        }
                        @if (sortedCoupons().length === 0) {
                            <p class="text-gray-500">Nenhum cupom cadastrado.</p>
                        }
                    </div>
                } @else {
                    <form [formGroup]="couponForm" (ngSubmit)="saveCoupon()" class="space-y-4">
                        <div><label class="block text-sm">C칩digo do Cupom (sem espa칞os)</label><input formControlName="code" class="w-full bg-gray-700 p-2 rounded uppercase"></div>
                        <div><label class="block text-sm">Descri칞칚o</label><textarea formControlName="description" class="w-full bg-gray-700 p-2 rounded" rows="2"></textarea></div>
                        <div>
                            <label class="block text-sm">Tipo de Desconto</label>
                            <select formControlName="discount_type" class="w-full bg-gray-700 p-2 rounded">
                                <option value="fixed">Valor Fixo (R$)</option>
                                <option value="percentage">Porcentagem (%)</option>
                                <option value="free_shipping">Frete Gr치tis</option>
                            </select>
                        </div>
                        @if (couponForm.get('discount_type')?.value !== 'free_shipping') {
                           <div><label class="block text-sm">Valor do Desconto</label><input type="number" formControlName="discount_value" class="w-full bg-gray-700 p-2 rounded"></div>
                        }
                        <div><label class="block text-sm">Valor M칤nimo do Pedido (Opcional)</label><input type="number" formControlName="minimum_order_value" placeholder="Deixe 0 para n칚o aplicar" class="w-full bg-gray-700 p-2 rounded"></div>
                        <div class="flex space-x-2">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                            <button type="button" (click)="editingCoupon.set(null)" class="bg-gray-600 hover:bg-gray-500 py-2 px-4 rounded-lg">Cancelar</button>
                        </div>
                    </form>
                }
              </div>
            </div>
          }
          @case('loyalty') {
            <div class="bg-gray-900 p-6 rounded-lg grid grid-cols-1 md:grid-cols-2 gap-8">
              <!-- Loyalty Program Rules -->
              <div>
                <h2 class="text-2xl font-semibold mb-4">Regras do Programa de Fidelidade</h2>
                <form [formGroup]="loyaltyForm" (ngSubmit)="saveLoyaltySettings()" class="space-y-4 bg-gray-800 p-4 rounded-lg">
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" formControlName="enabled" class="form-checkbox h-4 w-4 bg-gray-700 text-purple-600 mr-2">
                    <span>Ativar Programa de Fidelidade</span>
                  </label>
                  @if(loyaltyForm.get('enabled')?.value) {
                    <div class="pt-4 border-t border-gray-700 space-y-4">
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label class="block text-sm mb-1">Pontos por R$ 1 gasto</label>
                          <input type="number" formControlName="points_per_real" class="w-full bg-gray-700 p-2 rounded">
                        </div>
                        <div>
                          <label class="block text-sm mb-1">Pontos para Recompensa</label>
                          <input type="number" formControlName="points_for_reward" class="w-full bg-gray-700 p-2 rounded">
                        </div>
                      </div>
                      
                      <div>
                        <label class="block text-sm mb-1">Tipo de Recompensa</label>
                        <div class="flex space-x-4 p-2 bg-gray-700 rounded-md">
                            <label class="flex items-center cursor-pointer">
                              <input type="radio" formControlName="reward_type" value="fixed" class="form-radio h-4 w-4 bg-gray-800 border-gray-600 text-purple-600 focus:ring-purple-500">
                              <span class="ml-2">Valor Fixo (R$)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                              <input type="radio" formControlName="reward_type" value="free_shipping" class="form-radio h-4 w-4 bg-gray-800 border-gray-600 text-purple-600 focus:ring-purple-500">
                              <span class="ml-2">Frete Gr치tis</span>
                            </label>
                        </div>
                      </div>
  
                      @if (loyaltyForm.get('reward_type')?.value === 'fixed') {
                        <div>
                          <label class="block text-sm mb-1">Valor da Recompensa (R$)</label>
                          <input type="number" formControlName="reward_value" class="w-full bg-gray-700 p-2 rounded">
                        </div>
                      }
                    </div>
                  }
                  <div>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Regras</button>
                  </div>
                </form>
              </div>

              <!-- Customer Points -->
              <div>
                <h2 class="text-2xl font-semibold mb-4">Pontos dos Clientes</h2>
                <div class="bg-gray-800 p-4 rounded-lg">
                  <p class="text-xs text-gray-400 mb-4">Esta 칠 uma visualiza칞칚o de exemplo para demonstrar como os pontos dos clientes seriam exibidos. O sistema atual n칚o possui um banco de dados de usu치rios.</p>
                  <div class="max-h-96 overflow-y-auto">
                    <table class="w-full text-sm text-left">
                      <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                        <tr>
                          <th scope="col" class="px-4 py-2">Cliente</th>
                          <th scope="col" class="px-4 py-2 text-right">Pontos</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for(user of mockUsers(); track user.email) {
                          <tr class="border-b border-gray-700">
                            <td class="px-4 py-2 font-medium">{{ user.name }}<br><span class="text-xs text-gray-500">{{ user.email }}</span></td>
                            <td class="px-4 py-2 text-right font-bold text-purple-400">{{ user.loyalty_points }}</td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          }
        }
      </div>
    </div>
  }
  
  <!-- PDV Product Modal -->
  @if (isPdvProductModalOpen() && pdvSelectedProduct(); as product) {
    <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 p-4">
      <div class="rounded-lg w-full max-w-lg max-h-[90vh] overflow-y-auto scrollbar-hide bg-gray-800 text-white flex flex-col">
        <div class="sticky top-0 p-4 border-b flex justify-between items-center bg-gray-800 border-gray-700 z-10">
          <h2 class="text-2xl font-bold">{{ product.name }}</h2>
          <button (click)="closePdvProductModal()" class="text-gray-400 hover:text-white">&times;</button>
        </div>
        <div class="p-4 flex-grow overflow-y-auto">
          <p class="text-gray-400 mb-4">{{ product.description }}</p>
          
          @if (product.price_type !== 'fixed') {
            <h3 class="font-semibold mb-2">Tamanho</h3>
            <div class="grid grid-cols-2 gap-2 mb-4">
              @for (size of product.sizes; track size.name) {
                <button (click)="pdvSelectedSize.set(size)" 
                  class="p-3 border rounded-md text-left relative" 
                  [disabled]="!size.is_available"
                  [class.opacity-50]="!size.is_available"
                  [class.cursor-not-allowed]="!size.is_available"
                  [class.border-purple-500]="pdvSelectedSize()?.name === size.name" 
                  [class.bg-purple-500/20]="pdvSelectedSize()?.name === size.name" 
                  [class.border-gray-600]="pdvSelectedSize()?.name !== size.name">
                  <span class="font-medium">{{ size.name }}</span>
                  <span class="block text-sm text-purple-400">{{ size.price | currency:'BRL' }}</span>
                  @if (!size.is_available) {
                    <span class="absolute top-1 right-1 text-xs bg-red-600 text-white px-1.5 py-0.5 rounded">Indispon칤vel</span>
                  }
                </button>
              }
            </div>
          }

          @for (addonCatId of product.addon_categories; track addonCatId) {
            @if (getAddonCategoryById(addonCatId); as addonCat) {
              <div>
                <h3 class="font-semibold mb-2">{{ addonCat.name }} <span class="text-xs text-gray-500">{{ addonCat.required ? '(Obrigat칩rio)' : '(Opcional)'}}</span></h3>
                <div class="space-y-2 mb-4">
                  @for (addon of addonCat.addons; track addon.id) {
                    <label class="flex items-center justify-between p-3 rounded-md bg-gray-700"
                      [class.cursor-pointer]="addon.is_available"
                      [class.cursor-not-allowed]="!addon.is_available"
                      [class.opacity-60]="!addon.is_available">
                      <div>
                        <span>{{ addon.name }}</span>
                        @if (addon.price > 0) {
                          <span class="text-xs ml-2 text-purple-400">+{{ addon.price | currency:'BRL' }}</span>
                        } @else {
                          <span class="text-xs text-green-400 ml-2">Gr치tis</span>
                        }
                         @if (!addon.is_available) {
                          <span class="text-xs text-red-400 ml-2 font-semibold"> (Indispon칤vel)</span>
                        }
                      </div>
                      <input type="checkbox" class="form-checkbox h-5 w-5 bg-gray-800 border-gray-600 text-purple-600 focus:ring-purple-500 rounded" 
                        [checked]="pdvSelectedAddons()[addon.id]" 
                        [disabled]="!addon.is_available"
                        (change)="togglePdvAddon(addon)">
                    </label>
                  }
                </div>
              </div>
            }
          }
        </div>
        <div class="sticky bottom-0 p-4 border-t flex items-center justify-between bg-gray-800 border-gray-700">
          <div class="flex items-center space-x-2">
            <button (click)="decrementPdvQuantity()" class="w-8 h-8 rounded-md bg-gray-700">-</button>
            <span>{{ pdvProductQuantity() }}</span>
            <button (click)="incrementPdvQuantity()" class="w-8 h-8 rounded-md bg-gray-700">+</button>
          </div>
          <button (click)="addProductToPdvCartFromModal()" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg">Adicionar ao Pedido</button>
        </div>
      </div>
    </div>
  }

  @if(isReceiptModalOpen() && orderToPrint(); as order) {
    <app-receipt 
      [order]="order" 
      [settings]="dataService.settings()" 
      [mode]="receiptMode()"
      (close)="handleReceiptClose()"
      (confirm)="handleDeliveryConfirmation()"
      (sendWhatsApp)="handleSendReceipt(order)">
    </app-receipt>
  }
  
  <!-- Driver Assignment Modal -->
  @if (isDriverModalOpen()) {
    <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg w-full max-w-md">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">Atribuir Entrega</h3>
                <button (click)="isDriverModalOpen.set(false)" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-4">
                <p class="mb-4">Selecione um entregador ou envie para todos.</p>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    @for (driver of approvedDrivers(); track driver.id) {
                        <button (click)="assignOrder(driver.id)" class="w-full text-left p-3 rounded-lg bg-gray-700 hover:bg-gray-600">
                            {{ driver.name }}
                        </button>
                    }
                </div>
                <div class="mt-4 border-t border-gray-700 pt-4">
                    <button (click)="assignOrder('all')" class="w-full text-white font-bold py-3 px-4 rounded-lg bg-purple-600 hover:bg-purple-700">
                        Enviar para Todos
                    </button>
                </div>
            </div>
        </div>
    </div>
  }

  <!-- Confirmation Modal -->
  @if (isConfirmModalOpen()) {
    <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div class="bg-gray-800 rounded-lg w-full max-w-sm p-6 text-center">
        <h3 class="text-lg font-semibold mb-4">{{ confirmMessage() }}</h3>
        <div class="flex justify-center space-x-4">
          <button (click)="closeConfirmModal()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">
            Cancelar
          </button>
          <button (click)="handleConfirm()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg">
            Confirmar
          </button>
        </div>
      </div>
    </div>
  }
</div>